<%=
  FACTOR = 5/3.5
  result = {}
  @city.panoramas.keep_if{ |p| p.published && !p.exclusive }.each do |p| 
    cityPath = 'http://panorama-cities.net/' + FileHelper.to_filename(@city.en_name && @city.en_name != "" ? @city.en_name : @city.name ) + '/panoramas/'
    result[p.id] = {
      name: p.name,
      thumb:  cityPath + p.get_filename + '_3.jpg',
      rotation: p.rotation,
      repeative: p.repeative,
      priority: p.priority,
      image: cityPath + p.get_filename + '_5.jpg',
      date: p.date_of_recording,
      position: {
        latitude:  p.latitude,
        longitude:  p.longitude
      },
      links: []
    }
    p.internal_links.each do |l|
      path = l.path.split(/,/).map{ |x| x.strip.to_i * FACTOR }
      result[p.id][:links].push({
        panorama_id: l.destination_id,
        x: path[0],
        y: path[1],
        r: path[2]
      })
    end
  end
  result.to_json
%>